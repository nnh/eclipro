= form_for @protocol, html: { class: 'form-horizontal', role: 'form' } do |f|
  - if @protocol.errors.any?
    = model_errors(@protocol)

  div#step-one
    = render 'protocols/step/one', f: f, protocol: @protocol

  div#step-two
    = render 'protocols/step/two', f: f, protocol: @protocol

  div#step-three
    = render 'protocols/step/three', f: f, protocol: @protocol, contents: @contents

javascript:
  $(function() {
    $('#go-to-two').click((e) => {
      if ($('#protocol_title').val().length === 0) {
        showError(e);
      } else {
        let error_fields = $('.title-error')
        if (error_fields.length > 0) {
          let title = $('#protocol_title').val();
          for (let i = 0; i < error_fields.length; i++) {
            $(error_fields[i]).replaceWith($(error_fields[i]).html());
          }
          $('#protocol_title').val(title);
          $('#protocol_title_error').hide();
        }
        $('#step-one').hide();
        $('#step-two').show();
      }
    });
    $('#go-to-three').click(() => {
      $('#step-two').hide();
      $('#step-three').show();
    });
    $('#back-to-one').click(() => {
      $('#step-one').show();
      $('#step-two').hide();
    });
    $('#back-to-two').click(() => {
      $('#step-two').show();
      $('#step-three').hide();
    });

    $('#protocol_title_error').hide();
    $('#step-two').hide();
    $('#step-three').hide();
    $('#sponsor-other-form').hide();

    if (!$('#protocol_study_agent_1').prop('checked') && !$('#protocol_study_agent_2').prop('checked')) {
      $('#has-ind-form').hide();
    }
    if (!$('#protocol_study_agent_3').prop('checked')) {
      $('#has-ide-form').hide();
    }

    $('#protocol_sponsors').change(() => {
      if ($('#protocol_sponsors').children(':selected').last().text() === "#{I18n.t('protocols.step.one.sponsors').last()}") {
        $('#sponsor-other-form').show();
      } else {
        $('#sponsor-other-form').hide();
      }
    });

    $('.checkbox-form').change(() => {
      if ($('#protocol_study_agent_1').prop('checked') || $('#protocol_study_agent_2').prop('checked')) {
        $('#has-ind-form').show();
      } else {
        $('#has-ind-form').hide();
      }
      if ($('#protocol_study_agent_3').prop('checked')) {
        $('#has-ide-form').show();
      } else {
        $('#has-ide-form').hide();
      }
    });

    $('#step_one_submit_button').click((e) => {
      if ($('#protocol_title').val().length === 0) {
        showError(e);
      }
    });

    function showError(e) {
      e.preventDefault();
      let div = '<div class="field_with_errors title-error"></div>';
      $('label[for=protocol_title]').wrap(div);
      $('#protocol_title').wrap(div);
      $('#protocol_title_error').show();
      $('html, body').animate({ scrollTop: $('label[for=protocol_title]').offset().top });
    }

    $('#build-team-form-button').click((e) => {
      e.preventDefault();
      let added_user_ids = [''];
      $('[id$=_user_id]').each(function() {
        added_user_ids.push($(this).val());
      });
      let added_users_count = $('[id$=_user_id]').length;

      $.ajax({
        dataType: 'script',
        data: {
          protocol_id: '#{@protocol.id}',
          added_user_ids: added_user_ids
        },
        url: '#{build_team_form_protocols_path}'
      });
    });
  });
